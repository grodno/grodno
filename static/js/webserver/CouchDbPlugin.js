// Generated by CoffeeScript 1.8.0
(function() {
  Object.entity.define({
    id: 'webserver.CouchDbPlugin extends EventHandler',
    options: {},
    methods: function(_super) {
      var OPERATIONS, auth, cookies, db, _close, _find, _first, _insert, _items, _last, _obj, _open, _optionsKeys, _query, _queryOptionsFilter, _remove, _retPayload;
      auth = void 0;
      cookies = {};
      db = void 0;
      _open = function(home, cb) {
        db = (require('nano'))(home.options);
        return db.auth(home.user, home.pass, function(err, body, headers) {
          var v;
          if (v = headers != null ? headers['set-cookie'] : void 0) {
            auth = v;
          }
          return cb(null, db = db.use(home.dbId || home.id));
        });
      };
      _close = function() {
        auth = null;
        return db = null;
      };
      _obj = function(o) {
        if (typeof o === "string") {
          return Object.parse(o);
        } else {
          return o;
        }
      };
      _optionsKeys = ["limit", "sort", "fields", "skip", "hint", "explain", "snapshot", "timeout"];
      _queryOptionsFilter = function(params, r) {
        var k, v, _i, _len;
        if (r == null) {
          r = {};
        }
        for (_i = 0, _len = _optionsKeys.length; _i < _len; _i++) {
          k = _optionsKeys[_i];
          if (v = params[k]) {
            r[k] = v;
          }
        }
        r.sort = _obj(r.sort);
        r.fields = _obj(r.fields);
        r.limit = Number(r.limit) || 100;
        r.skip = Number(r.skip) || 0;
        return r;
      };
      _first = function(collectionId, flow) {
        return function() {
          this.next = flow.next;
          this.collectionId = collectionId;
          if (!this.query) {
            this.query = Object.parse(this.query) || _objectID(this.docId || this.hash);
          }
          if (!this.payload) {
            this.payload = this.doc || this.docs;
          }
          if (db) {
            return this.next(null, db);
          } else {
            return _open(this.home, this.next);
          }
        };
      };
      _query = function(err, db) {
        if (err) {
          return this.next(err);
        }
        return db.fetch(this.query, _queryOptionsFilter(this.options), this.next);
      };
      _items = function(err, body) {
        if (err) {
          return this.next(err);
        } else {
          return this.next(null, body.rows);
        }
      };
      _find = function(err, db) {
        return db.get(this.query, this.next);
      };
      _insert = function(err, db) {
        return db.insert(this.payload, this, this.next);
      };
      _remove = function(err, db) {
        return db.destroy(this.query, this.rev, this.next);
      };
      _retPayload = function(err) {
        return this.next(err, err ? null : this.payload);
      };
      _last = function(err, result, headers) {
        var v;
        if (err) {
          this.home.error(err);
          _close();
        }
        if (v = headers != null ? headers['set-cookie'] : void 0) {
          auth = v;
        }
        return this.next(err, result);
      };
      OPERATIONS = {
        query: [_query, _items],
        find: [_find],
        insert: [_insert, _retPayload],
        update: [_update, _retPayload],
        remove: _remove
      };
      return {
        handleEvent: function(ev) {
          var collectionId, op, opts;
          collectionId = ev.uri.domain;
          op = ev.uri.path[0] || 'query';
          opts = Object.clone(ev, {
            home: this
          });
          this.log(collectionId, op);
          return Function.perform(opts, function(flow) {
            return [_first(collectionId, flow)].concat(_auth, OPERATIONS[op], _last, ev.callback);
          });
        },
        done: function() {
          _close();
          return _super.done.call(this);
        }
      };
    }
  });

}).call(this);
